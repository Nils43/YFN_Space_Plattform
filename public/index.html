<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
  
    
  </style>
</head>
    
  <div class="brand">
    <div class="brand-left">
      <img src="YFN.svg" alt="Young Founders Network Logo" width="100">
      <div class="name">
      <h2>Young</h2>
      <h2> Founders</h2>
      <h2>Network</h2>
    </div>
  </div>
    <nav class="nav">
      <a href="https://www.youngfounders.network">Community</a>
      <a href="https://luma.com/calendar/manage/cal-c9CVdKRbXTwUE0q">Events</a>
      <a href="mailto:nils.heck@youngfounders.network">Kontakt</a>
    </nav>
  </div>
  
    
      <div class="partner">
        <h2>Unsere Partner</h2>
        <ul class="logos">
          <li><img src="Code.png" alt="Code University of Applied Science"></li>
          <li><img src="Delta.png" alt="Delta Campus"></li>
        </ul>
      </div>
    </body>

 
      <section class="row">
     
        <div class="card">
          <h2>Jetzt buchen</h2>
          <h3>Buche direkt deinen Tisch und arbeite effizient und effektiv in einem YFN Space</h3>
        
          <form method="post" action="/bookings" class="form booking-form">
            <div class="field">
              <label for="bf-name">Dein Name</label>
              <input id="bf-name" name="user_name" required>
            </div>
        
            <div class="field">
              <label for="bf-resource">Ressource</label>
              <select id="bf-resource" name="resource_id" required>
                <option value="1">Tisch 1</option>
                <option value="2">Tisch 2</option>
                <option value="3">Tisch 3</option>
                <option value="4">Tisch 4</option>
              </select>
            </div>
        
            <div class="field two-col">
              <div>
                <label for="bf-start">Start</label>
                <input id="bf-start" type="datetime-local" name="start_at" required>
              </div>
              <div>
                <label for="bf-end">Ende</label>
                <input id="bf-end" type="datetime-local" name="end_at" required>
              </div>
            </div>
        
            <button type="submit" class="btn btn-primary w-full">Jetzt buchen</button>
        

          </form>
        </div>
        
        <div class="card">
          <h2>Kalender <small id="weekLabel" style="font-weight:500;color:#5E697B;"></small></h2>
          <div class="calendar">
            <div class="legend">
              <span class="chip"><span class="dot dot-free"></span> frei</span>
              <span class="chip"><span class="dot dot-busy"></span> belegt</span>
            </div>
        
            <div id="weekGrid" class="week-grid"></div>
          </section>
        
            <div id="slotTooltip" class="slot-tooltip" hidden>
              <div class="slot-tooltip__time" id="tipTime"></div>
              <div class="slot-tooltip__list" id="tipList"></div>
            </div>
          </div>
        </div>
        
    <div class="benefits">
      <h2>Benefits</h2>
    
      <ul class="benefit-list">
        <li class="benefit-item">
          <span class="material-icons icon-xl" aria-hidden="true">shield</span>
          <h3>Nur für YFN‑Member</h3>
        </li>
    
        <li class="benefit-item">
          <span class="material-icons icon-xl" aria-hidden="true">calendar_today</span>
          <h3>Kalender‑Export</h3>
        </li>
    
        <li class="benefit-item">
          <span class="material-icons icon-xl" aria-hidden="true">chair_alt</span>
          <h3>11 Plätze</h3>
        </li>
      </ul>
    </div>
  </body>
</html>

<script>
  (function () {
    const p = new URLSearchParams(location.search);
    const ok = p.get('ok');
    const err = p.get('error');
    if (ok) showToast('Buchung erfolgreich!', 'success');
    if (err === 'belegt') showToast('Zeitfenster ist belegt. Bitte anderen Slot wählen.', 'error');
    if (err === 'invalid_time') showToast('Startzeit muss vor Endzeit liegen.', 'error');
    if (err === 'missing') showToast('Bitte alle Felder ausfüllen.', 'error');
    if (err === 'server') showToast('Interner Fehler. Bitte später erneut versuchen.', 'error');

    function showToast(text, type) {
      const t = document.createElement('div');
      t.className = 'toast ' + (type || 'info');
      t.textContent = text;
      document.body.appendChild(t);
      setTimeout(() => t.classList.add('in'), 10);
      setTimeout(() => t.classList.remove('in'), 3200);
      setTimeout(() => t.remove(), 3600);
    }
  })();
</script>

<script>

  const fmt2 = n => String(n).padStart(2,'0');
  const overlap = (aStart, aEnd, bStart, bEnd) => aStart < bEnd && bStart < aEnd;

  let CAL = null; 

  async function loadCalendar(resourceIds = [1,2,3,4]) {
    const q = encodeURIComponent(resourceIds.join(','));
    const res = await fetch(`/api/calendar?resource_ids=${q}`);
    if (!res.ok) throw new Error('Kalender konnte nicht geladen werden');
    CAL = await res.json();

    const wl = document.getElementById('weekLabel');
    if (wl) wl.textContent = `(${CAL.weekStart})`;

    renderWeekGrid();
    attachHoverHandlers();
  }

  function renderWeekGrid() {
    const grid = document.getElementById('weekGrid');
    grid.innerHTML = '';
    const days = ['Mo','Di','Mi','Do','Fr','Sa','So'];

  
    const base = new Date(CAL.weekStart + 'T00:00:00');

    for (let d = 0; d < 7; d++) {
      const dayCol = document.createElement('div');
      dayCol.className = 'day-col';

      const label = document.createElement('div');
      label.className = 'day-label' + (d === 0 ? ' day-label--focus' : '');
      label.textContent = days[d];
      dayCol.appendChild(label);

      const dayDate = new Date(base);
      dayDate.setDate(base.getDate() + d);

      for (let h = CAL.startHour; h < CAL.endHour; h++) {
        for (let m = 0; m < 60; m += CAL.stepMin) {
          const start = new Date(dayDate);
          start.setHours(h, m, 0, 0);
          const end = new Date(start);
          end.setMinutes(end.getMinutes() + CAL.stepMin);

    
          const allBusy = CAL.resourceIds.every(rid => isBusyFor(rid, start, end));

          const slot = document.createElement('div');
          slot.className = 'slot ' + (allBusy ? 'busy' : 'free');
          slot.dataset.start = start.toISOString();
          slot.dataset.end = end.toISOString();
          slot.dataset.label = `${fmt2(start.getHours())}:${fmt2(start.getMinutes())}–${fmt2(end.getHours())}:${fmt2(end.getMinutes())}`;
          dayCol.appendChild(slot);
        }
      }
      grid.appendChild(dayCol);
    }
  }

  function isBusyFor(resourceId, start, end) {
    const list = CAL.busyByResource?.[resourceId] || [];
  
    if (list.length && typeof list[0].start === 'string') {
      for (let i = 0; i < list.length; i++) {
        list[i].start = new Date(list[i].start);
        list[i].end = new Date(list[i].end);
      }
    }
    return list.some(intv => overlap(start, end, intv.start, intv.end));
  }


  const tooltip = document.getElementById('slotTooltip');
  const tipTime = document.getElementById('tipTime');
  const tipList = document.getElementById('tipList');

  function positionTooltipNearSlot(slot, tooltip) {

  const CAL_CONTAINER = document.querySelector('.calendar');
  const calRect = CAL_CONTAINER.getBoundingClientRect();
  const slotRect = slot.getBoundingClientRect();

  const offsetX = 10; 
  const offsetY = 6;  


  let left = calRect.left + window.scrollX + (slotRect.right - calRect.left) + offsetX;
  let top  = calRect.top  + window.scrollY + (slotRect.top  - calRect.top) + offsetY;


  tooltip.style.left = left + 'px';
  tooltip.style.top  = top  + 'px';

  const tipRect = tooltip.getBoundingClientRect();
  const vw = window.innerWidth;
  const vh = window.innerHeight;


  if (tipRect.right > vw - 8) {
    left = calRect.left + window.scrollX + (slotRect.left - calRect.left) - tipRect.width - offsetX;
  }

  if (tipRect.bottom > vh - 8) {
    top = calRect.top + window.scrollY + (slotRect.bottom - calRect.top) - tipRect.height - offsetY;
  }

  tooltip.style.left = Math.max(window.scrollX + 8, left) + 'px';
  tooltip.style.top  = Math.max(window.scrollY + 8, top)  + 'px';
}


  function attachHoverHandlers() {
    const slots = document.querySelectorAll('.slot');
   

    slots.forEach(slot => {
      slot.addEventListener('mouseenter', (e) => {
        const start = new Date(slot.dataset.start);
        const end = new Date(slot.dataset.end);

        tipTime.textContent = slot.dataset.label;
        tipList.innerHTML = '';

        CAL.resourceIds.forEach(rid => {
          const busy = isBusyFor(rid, start, end);
          const item = document.createElement('div');
          item.className = 'slot-tooltip__item';
          item.innerHTML = `<div>Tisch ${rid}</div><div class="${busy ? 'status-busy' : 'status-free'}">${busy ? 'belegt' : 'frei'}</div>`;
          tipList.appendChild(item);
        });

        const offset = 12;
        tooltip.style.left = (e.pageX + offset) + 'px';
        tooltip.style.top  = (e.pageY + offset) + 'px';
        tooltip.hidden = false;
      });

      slot.addEventListener('mousemove', (e) => {
        if (tooltip.hidden) return;
        const offset = 12;
        tooltip.style.left = (e.pageX + offset) + 'px';
        tooltip.style.top  = (e.pageY + offset) + 'px';
      });

      slot.addEventListener('mouseleave', () => {
        tooltip.hidden = true;
      });
    });
    


   
    const calendar = document.querySelector('.calendar');
    calendar.addEventListener('mouseleave', () => { tooltip.hidden = true; });
  }

  
  loadCalendar([1,2,3,4]).catch(err => {
    console.error('loadCalendar error:', err);
  });
</script>
